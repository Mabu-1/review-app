{% schema %}
{
  "name": "Review Gallery Pro",
  "target": "section"
}
{% endschema %}

{% assign app_settings = shop.metafields.review_gallery.settings.value %}
{% assign final_heading = app_settings.heading | default: "Customer Reviews" %}

<div style="padding: 40px 20px; margin: 0 auto; max-width: 1400px;">
  <h2 style="text-align: center; margin-bottom: 30px;">{{ final_heading }}</h2>
  
  <style>
    /* --- GRID CONTAINERS --- */
    #rg-container {
      display: flex;
      gap: 20px;
      align-items: flex-start;
      justify-content: center;
      width: 100%;
    }
    
    /* Standard Grid Class (toggled via Dashboard Setting) */
    #rg-container.rg-standard-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
    }
    
    @media (max-width: 1024px) {
      #rg-container.rg-standard-grid { grid-template-columns: repeat(3, 1fr); }
    }
    @media (max-width: 768px) {
      #rg-container { flex-direction: column; }
      #rg-container.rg-standard-grid { grid-template-columns: 1fr; }
      .rg-column { width: 100%; }
      .rg-modal-content { flex-direction: column; height: 90vh; }
      .rg-modal-left { flex: 1; min-height: 40%; }
      .rg-modal-right { flex: 1; padding: 20px; }
      .rg-close { top: 10px; right: 10px; background: white; }
    }

    .rg-column {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 20px;
      min-width: 0;
    }

    /* --- CARD DESIGN --- */
    .rg-card {
      border: 1px solid #eee;
      padding: 16px;
      border-radius: 12px;
      background: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      width: 100%;
      box-sizing: border-box;
      opacity: 0;
      animation: fadeIn 0.5s forwards;
    }
    @keyframes fadeIn { to { opacity: 1; } }
    .rg-card:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }

    /* --- LANDSCAPE THUMBNAILS --- */
    .rg-image-wrap {
      width: 100%;
      aspect-ratio: 1.5 / 1; 
      overflow: hidden;
      border-radius: 8px;
      margin-bottom: 15px;
      background: #f5f5f5;
      position: relative;
      cursor: zoom-in;
    }
    .rg-image-wrap img {
      width: 100%; height: 100%;
      object-fit: cover; 
      display: block; position: absolute;
      top: 0; left: 0; transition: transform 0.4s;
    }
    .rg-image-wrap:hover img { transform: scale(1.05); }

    /* --- PRO LIGHTBOX (Popup) --- */
    .rg-modal {
      display: none; position: fixed; z-index: 10000;
      left: 0; top: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.85);
      align-items: center; justify-content: center;
      backdrop-filter: blur(5px); padding: 20px; box-sizing: border-box;
    }
    .rg-modal.active { display: flex; }

    .rg-modal-content {
      display: flex; background: white;
      width: 100%; max-width: 900px;
      height: 80vh; max-height: 600px;
      border-radius: 12px; overflow: hidden;
      box-shadow: 0 20px 50px rgba(0,0,0,0.5); position: relative;
    }

    .rg-modal-left { flex: 1.5; background: #000; display: flex; align-items: center; justify-content: center; position: relative; }
    .rg-modal-left img { max-width: 100%; max-height: 100%; object-fit: contain; }
    .rg-modal-right { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }

    /* Navigation */
    .rg-nav-btn {
      position: absolute; top: 50%; transform: translateY(-50%);
      background: rgba(255,255,255,0.2); color: white; border: none;
      width: 40px; height: 40px; border-radius: 50%; font-size: 20px; cursor: pointer;
      display: flex; align-items: center; justify-content: center; transition: 0.2s;
    }
    .rg-nav-btn:hover { background: rgba(255,255,255,0.4); }
    .rg-prev { left: 15px; } .rg-next { right: 15px; }

    .rg-close {
      position: absolute; top: 15px; right: 15px;
      background: rgba(0,0,0,0.1); width: 30px; height: 30px;
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      cursor: pointer; font-weight: bold; color: #333; z-index: 2;
    }
    .rg-close:hover { background: rgba(0,0,0,0.2); }
  </style>
  
  <div id="rg-container"></div>
  <div id="rg-status" style="text-align:center; padding: 20px;">Loading...</div>
</div>

<div id="rg-modal" class="rg-modal">
  <div class="rg-modal-content">
    <div class="rg-close" onclick="closeModal()">✕</div>
    <div class="rg-modal-left">
      <button class="rg-nav-btn rg-prev" onclick="changeSlide(-1)">❮</button>
      <img id="rg-modal-img" src="" width="1" height="1">
      <button class="rg-nav-btn rg-next" onclick="changeSlide(1)">❯</button>
    </div>
    <div class="rg-modal-right">
      <div id="rg-modal-info"></div>
    </div>
  </div>
</div>

<script>
  (function() {
    // 1) SHOP SETTINGS (global fallback)
    let appSettings = {};
    const metaJson = {{ shop.metafields.review_gallery.settings.value | json }};
    if (metaJson && typeof metaJson === 'object') {
      appSettings = metaJson;
    }

    // 2) PRODUCT CSV (primary) - safe default "" so it won't break outside product pages
    const productCsvUrl = {{ product.metafields.review_gallery.csv_url.value | default: "" | json }};

    // 3) FINAL CSV PICKING LOGIC:
    // product csv -> global csv -> hardcoded fallback
    let csvUrl =
      (productCsvUrl && productCsvUrl.length > 0) ? productCsvUrl :
      (appSettings.csvUrl && appSettings.csvUrl.length > 0) ? appSettings.csvUrl :
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vRZu2hO296yBu6jdFduuiWOlVGvSIGRo0I7EKkdAbmLQ4WIwFGyawoBVodxuhjy0DMycJK9D98d38DS/pub?output=csv";

    // 4) SETTINGS
    const starColor = appSettings.starColor || "#FFC107";
    const layoutStyle = appSettings.layoutStyle || "masonry";
    const showVerifiedSetting = appSettings.showVerifiedBadge !== undefined ? appSettings.showVerifiedBadge : true;

    const container = document.getElementById('rg-container');
    const status = document.getElementById('rg-status');
    let lightboxData = []; 
    let currentIndex = 0;

    // 5) APPLY LAYOUT STYLE (Masonry vs Grid)
    const columns = [];
    if (layoutStyle === "masonry") {
      let colCount = window.innerWidth <= 768 ? 1 : 5; 
      for(let i=0; i<colCount; i++) {
        let col = document.createElement('div');
        col.className = 'rg-column';
        container.appendChild(col);
        columns.push(col);
      }
    } else {
      container.classList.add('rg-standard-grid');
    }

    // 6) FETCH DATA
    const separator = csvUrl.includes('?') ? '&' : '?';
    fetch(csvUrl + separator + 't=' + Date.now())
      .then(r => r.text())
      .then(text => {
        const rows = text.split('\n').slice(1);
        let count = 0;

        rows.forEach((row) => {
          const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
          if(cols.length < 3) return;
          
          const author = cols[2] ? cols[2].replace(/"/g, '').trim() : '';
          if(!author) return;

          const rating = parseInt(cols[1]) || 5;
          const body = cols[4] ? cols[4].replace(/"/g, '').trim() : '';
          const stars = "★".repeat(rating) + "☆".repeat(5 - rating);
          const rawImg = (cols[6] && cols[6].length > 5) ? cols[6].trim() : null;
          
          const isVerifiedData = (cols[7] && (cols[7].toUpperCase().includes('TRUE') || cols[7].includes('1')));
          const showBadge = showVerifiedSetting && isVerifiedData;
          
          let formattedDate = '';
          try { 
            const d = new Date((cols[5] || "").trim()); 
            if(!isNaN(d)) formattedDate = d.toLocaleDateString(); 
          } catch(e){}

          let imgHtml = '';
          if(rawImg) {
             const lbIndex = lightboxData.length; 
             lightboxData.push({ author, rating, body, img: rawImg, isVerified: showBadge, date: formattedDate });
             imgHtml = `<div class="rg-image-wrap" onclick="openModal(${lbIndex})"><img src="${rawImg}" alt="Review"></div>`;
          }

          let verifiedHtml = showBadge ? `<span style="display:inline-flex; align-items:center; gap:3px; background:#e8f5e9; color:#2e7d32; padding:2px 6px; border-radius:10px; font-size:10px; font-weight:700; text-transform:uppercase; margin-left:6px;"><svg style="width:10px; height:10px; fill:currentColor;" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"></path></svg>Verified</span>` : '';

          const card = document.createElement('div');
          card.className = 'rg-card';
          card.innerHTML = `
              ${imgHtml}
              <div style="display:flex; justify-content:space-between; margin-bottom:10px; align-items: flex-start;">
                <div style="display:flex; align-items:center; flex-wrap:wrap;"><span style="font-weight:700; font-size:13px; color:#333;">${author}</span>${verifiedHtml}</div>
                <span style="font-size:11px; color:#999; white-space:nowrap;">${formattedDate}</span>
              </div>
              <div style="color:${starColor}; font-size:15px; margin-bottom:8px;">${stars}</div>
              <div style="font-size:13px; line-height:1.5; color:#555;">${body}</div>
          `;

          if (layoutStyle === "masonry") {
            let shortestCol = columns[0];
            for(let col of columns) {
              if(col.offsetHeight < shortestCol.offsetHeight) shortestCol = col;
            }
            shortestCol.appendChild(card);
          } else {
            container.appendChild(card);
          }
          count++;
        });

        status.style.display = (count > 0) ? 'none' : 'block';
        if(count === 0) status.innerText = "No reviews found.";
      })
      .catch(e => { status.innerHTML = `<span style="color:red;">Error loading CSV. Make sure your link is valid!</span>`; });

    // --- LIGHTBOX LOGIC ---
    window.openModal = function(index) {
      if(lightboxData.length === 0) return;
      currentIndex = index;
      updateModal();
      document.getElementById('rg-modal').classList.add('active');
      document.body.style.overflow = 'hidden'; 
    };

    window.closeModal = function() {
      document.getElementById('rg-modal').classList.remove('active');
      document.body.style.overflow = 'auto'; 
    };

    window.changeSlide = function(step) {
      if(lightboxData.length <= 1) return; 
      let newIndex = currentIndex + step;
      if(newIndex >= lightboxData.length) newIndex = 0;
      if(newIndex < 0) newIndex = lightboxData.length - 1;
      currentIndex = newIndex;
      updateModal();
    };

    function updateModal() {
      const r = lightboxData[currentIndex];
      if(!r) return;
      
      document.getElementById('rg-modal-img').src = r.img; 
      const stars = "★".repeat(r.rating) + "☆".repeat(5 - r.rating);
      let verifiedHtml = r.isVerified ? `<span style="display:inline-flex; align-items:center; gap:3px; background:#e8f5e9; color:#2e7d32; padding:3px 8px; border-radius:12px; font-size:11px; font-weight:700; text-transform:uppercase; margin-left:8px;">Verified</span>` : '';

      document.getElementById('rg-modal-info').innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:15px;">
           <div>
             <div style="font-weight:800; font-size:16px; color:#333; display:flex; align-items:center;">${r.author} ${verifiedHtml}</div>
             <div style="font-size:12px; color:#888; margin-top:4px;">${r.date}</div>
           </div>
        </div>
        <div style="color:${starColor}; font-size:20px; margin-bottom:15px;">${stars}</div>
        <div style="font-size:15px; line-height:1.6; color:#444;">${r.body}</div>
      `;
    }
    
    document.getElementById('rg-modal').addEventListener('click', function(e) {
      if(e.target === this) closeModal();
    });
  })();
</script>
